- group: Spearphishing attachment execution of files written by Microsoft Office processes
  description: |
    Adversaries may send spearphishing emails with a malicious attachment in an
    attempt to gain access to victim systems. Spearphishing attachment is a specific
    variant of spearphishing. Spearphishing attachment is different from other forms
    of spearphishing in that it employs the use of malware attached to an email.
  labels:
    tactic.id: TA0001
    tactic.name: Initial Access
    tactic.ref: https://attack.mitre.org/tactics/TA0001/
    technique.id: T1566
    technique.name: Phishing
    technique.ref: https://attack.mitre.org/techniques/T1566/
    subtechnique.id: T1566.001
    subtechnique.name: Spearphishing Attachment
    subtechnique.ref: https://attack.mitre.org/techniques/T1566/001/
  rules:
    - name: File execution via Microsoft Office process
      condition: >
        sequence
        maxspan 1h
          |create_file
              and
           (file.extension iin executable_extensions or file.is_exec)
              and
           ps.name iin msoffice_binaries
          | by file.name
          |spawn_process
              and
           ps.name iin msoffice_binaries
          | by ps.child.exe
      min-engine-version: 2.0.0
    - name: Potentially malicious module loaded by Microsoft Office process
      condition: >
        sequence
        maxspan 1h
          |create_file
              and
           (file.extension iin module_extensions or file.is_dll)
              and
           ps.name iin msoffice_binaries
          | by file.name
          |load_module
              and
           ps.name iin msoffice_binaries
          | by image.name
      min-engine-version: 2.0.0
    - name: Executable file creation from a macro-enabled Microsoft Office document
      description: |
        Identifies the Microsoft Office process writing an executable file type and
        the call stack reveals the file creation was originated from the Microsoft
        Visual Basic for Applications module. This may be an indicator of initial
        access using malicious macro-enabled documents.
      condition: >
        create_file
            and
        ps.name in msoffice_binaries
            and
        thread.callstack.modules imatches 'vbe?.dll'
            and
        (
          file.extension iin ('.vbs', '.js', '.jar', '.exe', '.dll', '.com',
                              '.ps1', '.hta', '.cmd', '.vbe', '.rar.', '.zip',
                              '.iso', '.img', '.wsh', '.bat', '.cpl', '.7z'
                              )
              or
          (file.is_exec or file.is_dll)
        )
      min-engine-version: 2.2.0
